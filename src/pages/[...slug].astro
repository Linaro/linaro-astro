---
import Flow from "@/layouts/Flow.astro";
import { getCollection, getEntry, render } from "astro:content";

export async function getStaticPaths() {
  const pages = await getCollection("pages");
  return pages
    .filter((page) => page.id !== "404.md")
    .map((page) => {
      const slug =
        page.id === "homepage.md" ? undefined : page.id.replace(/\.mdx?$/, "");

      return {
        params: { slug },
        props: { page },
      };
    });
}

const { slug } = Astro.params;
let page = Astro.props.page;

if (!page) {
  const lookupId = slug === undefined ? "homepage" : slug;
  page = await getEntry("pages", lookupId);
}

if (!page) {
  return Astro.redirect("/404");
}

const { Content } = await render(page);
---

<Flow frontmatter={page}>
  <Content />
</Flow>
