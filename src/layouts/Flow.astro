---
import type { AstroComponentFactory } from "astro/runtime/server/index.js";
import { getEntries } from "astro:content";
import type { CollectionEntry } from "astro:content";
import BaseLayout from "./BaseLayout.astro";
import Hero from "@/components/hero/Hero.astro";
import ConnectHero from "@/components/hero/ConnectHero.astro";

type Props = { frontmatter: CollectionEntry<"pages"> };

const { frontmatter } = Astro.props;
const { title, description, flow, hero, connectHero } = frontmatter.data;

const allComponents = import.meta.glob("../components/{sections,rows}/*.astro");

const rowComponents: Record<string, { default: AstroComponentFactory }> = {};
const sectionComponents: Record<string, { default: AstroComponentFactory }> =
  {};

if (flow && flow.length > 0) {
  const rowsToFetch = flow.map((row: any) => row.row);
  const fetchedRows = await getEntries(rowsToFetch);

  for (const rowData of fetchedRows) {
    const path = rowData.data.path.replace("@/components", "../components");
    if (allComponents[path]) {
      const comp = await allComponents[path]();
      rowComponents[rowData.id] = comp as any;
      if (rowData.slug) rowComponents[rowData.slug] = comp as any;
    }
  }

  const sectionsToFetch = flow.flatMap(
    (row: any) => row.sections?.map((s: any) => s.component) || [],
  );
  const fetchedSections = await getEntries(sectionsToFetch);

  for (const sectionData of fetchedSections) {
    const path = sectionData.data.path.replace("@/components", "../components");
    if (allComponents[path]) {
      const comp = await allComponents[path]();
      sectionComponents[sectionData.id] = comp as any;
      if (sectionData.slug) sectionComponents[sectionData.slug] = comp as any;
    }
  }
}
---

<BaseLayout title={title} description={description}>
  <main class="prose mx-0 max-w-full prose-invert" data-pagefind-body>
    <span data-pagefind-meta="title" class="hidden">{title}</span>
    {hero && <Hero {...hero} />}
    {connectHero && <ConnectHero {...connectHero} />}

    {
      flow?.map((row: any) => {
        // Look for .slug (from your transform) or .id (from Astro)
        const rowId = row.row?.slug || row.row?.id || row.row;
        const RowComp = rowComponents[rowId]?.default;

        return RowComp ? (
          <RowComp {...row}>
            {row.sections?.map((section: any) => {
              // Access the slug inside the component object created by your transform
              const sectionId =
                section.component?.slug ||
                section.component?.id ||
                section.component;
              const SectionComp = sectionComponents[sectionId]?.default;

              return SectionComp ? (
                <SectionComp {...section} />
              ) : (
                <div class="bg-red-900 text-white p-2">
                  Section "{sectionId}" not found.
                  {/* Optional: Add debug helper */}
                  Available:{" "}
                  {Object.keys(sectionComponents).slice(0, 5).join(", ")}
                </div>
              );
            })}
          </RowComp>
        ) : (
          <div class="bg-red-600 text-white p-4">
            Debug: Row "{rowId}" not found. Available:{" "}
            {Object.keys(rowComponents).join(", ")}
          </div>
        );
      })
    }
  </main>
</BaseLayout>
